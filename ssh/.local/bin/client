#!/usr/bin/env bash

# you need client in ~/.ssh/config for this
# Usage: client cmd -params file1 file2
# runs the the command on the client machine with the given files copied over
# it tries to detect local files and rsync them to the client
# client -i will not try to do that

set -e


client_args=''
case "$1" in
    -i)
        # don't try to transfer stuff
        shift
        client_args="$@"
        ignore=1
        ;;
esac

cmd=$1
shift

if [ -z "$ignore" ]; then
    server_files=''
    for arg in "$@"; do
        if [ -e "$arg" ]; then
            # set up for copying it
            file=`readlink -f $arg`
            server_files+=" $file"
            client_args+=" /tmp/$file"
        else
            client_args+=" $arg"
        fi
    done
    # -R relative path names preserve the full paths from the command line
    rsync -aqzR $server_files client:/tmp
fi

ssh client -- /usr/bin/env "$cmd" "$client_args"
